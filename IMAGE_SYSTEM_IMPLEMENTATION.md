# تنفيذ نظام إدارة الصور

## نظرة عامة

تم تنفيذ نظام شامل لإدارة الصور في المدونة الاحترافية، مع دعم كامل للصور المحلية والخارجية، والتحميل الكسول، والصور المتجاوبة.

## المكونات المنفذة

### 1. مكون OptimizedImage (`src/components/OptimizedImage.astro`)

مكون محسّن لعرض الصور مع الميزات التالية:

- **دعم الصور المحلية والخارجية**: يتعرف تلقائياً على نوع الصورة
- **التحميل الكسول (Lazy Loading)**: القيمة الافتراضية `lazy` مع إمكانية استخدام `eager` للصور في الأعلى
- **الصور المتجاوبة (Responsive Images)**: توليد `srcset` و `sizes` تلقائياً
- **التحقق من النص البديل**: تحذير في حالة عدم وجود `alt text`
- **تحسين الأداء**: استخدام `decoding="async"` لتحسين الأداء

#### الاستخدام:

```astro
<OptimizedImage
  src="/images/post.jpg"
  alt="عنوان المقالة"
  width={800}
  height={400}
  loading="lazy"
  widths={[400, 800, 1200]}
  sizes="(max-width: 768px) 100vw, 800px"
/>
```

### 2. دوال المساعدة (`src/utils/image.ts`)

مجموعة من الدوال المساعدة لإدارة الصور:

#### `validateAltText(alt: string | undefined): boolean`
- التحقق من وجود نص بديل صحيح للصورة
- يعيد `false` إذا كان النص فارغاً أو غير موجود

#### `isExternalImage(src: string): boolean`
- تحديد ما إذا كانت الصورة محلية أو خارجية
- يتحقق من بداية الرابط بـ `http://` أو `https://`

#### `isValidImageFormat(src: string): boolean`
- التحقق من صيغة الصورة
- يدعم: JPG, JPEG, PNG, WebP, SVG, GIF

#### `generateSrcSet(baseSrc: string, widths: number[]): string`
- توليد `srcset` للصور المتجاوبة
- يعمل فقط مع الصور المحلية

#### `generateSizes(breakpoints?: object): string`
- توليد `sizes` attribute للصور المتجاوبة
- يوفر قيم افتراضية معقولة

#### `getDefaultImage(): string`
- الحصول على صورة افتراضية في حالة عدم وجود صورة

### 3. التحديثات على المكونات الموجودة

#### BlogCard Component
- تم تحديثه لاستخدام `OptimizedImage`
- إضافة `srcset` و `sizes` للصور المصغرة
- تحسين الأداء مع lazy loading

#### Blog Post Page
- تم تحديثه لاستخدام `OptimizedImage`
- الصورة البارزة تستخدم `eager` loading
- المقالات المقترحة تستخدم `lazy` loading
- دعم كامل للصور المتجاوبة

## الاختبارات المنفذة

### 1. اختبارات الوحدة (`src/utils/image.test.ts`)

اختبارات شاملة لجميع دوال المساعدة:
- التحقق من النص البديل
- تحديد نوع الصورة (محلية/خارجية)
- التحقق من صيغ الصور
- توليد srcset

### 2. اختبارات قائمة على الخصائص (Property-Based Tests)

#### خاصية 10: دعم الصور المحلية والخارجية
- اختبار 100 حالة عشوائية
- التحقق من التعرف الصحيح على نوع الصورة

#### خاصية 28: دعم صيغ الصور المتعددة
- اختبار جميع الصيغ المدعومة
- التحقق من عدم حساسية الحالة

#### خاصية 31: نص بديل للصور
- التحقق من وجود alt text لجميع الصور
- اختبار حالات النص الفارغ والمسافات

### 3. اختبارات المكونات (`src/components/OptimizedImage.test.ts`)

#### خاصية 17: التحميل الكسول
- التحقق من استخدام lazy loading للصور خارج viewport
- دعم eager loading للصور في الأعلى

#### خاصية 29: تحسين الصور للشاشات المختلفة
- التحقق من توليد srcset صحيح
- اختبار sizes attribute

#### خاصية 30: عرض الصورة البارزة
- التحقق من عرض الصورة البارزة في البطاقات والصفحات
- معالجة حالة عدم وجود صورة

## الميزات المنفذة

### ✅ إعداد نظام الصور
- مكون OptimizedImage محسّن
- دوال مساعدة شاملة
- دعم كامل للصور المحلية والخارجية

### ✅ التحميل الكسول (Lazy Loading)
- lazy loading افتراضي لجميع الصور
- eager loading للصور في viewport الأولي
- تحسين الأداء مع decoding="async"

### ✅ الصور المتجاوبة (Responsive Images)
- توليد srcset تلقائي بأحجام متعددة
- sizes attribute قابل للتخصيص
- دعم الشاشات المختلفة

### ✅ التحقق من النص البديل
- تحذير عند عدم وجود alt text
- دالة validateAltText للتحقق
- دعم إمكانية الوصول (Accessibility)

### ✅ دعم صيغ الصور المتعددة
- JPG, JPEG, PNG, WebP, SVG, GIF
- التحقق من الصيغة قبل المعالجة
- دعم الصور الخارجية

### ✅ الصورة البارزة
- عرض في بطاقات المقالات
- عرض في صفحة المقالة
- معالجة حالة عدم وجود صورة

## المتطلبات المحققة

- ✅ المتطلب 4.3: دعم الصور المحلية والخارجية
- ✅ المتطلب 6.3: التحميل الكسول للصور
- ✅ المتطلب 10.1: دعم صيغ الصور المتعددة
- ✅ المتطلب 10.2: تحسين الصور للشاشات المختلفة
- ✅ المتطلب 10.3: عرض الصورة البارزة
- ✅ المتطلب 10.4: نص بديل للصور
- ✅ المتطلب 10.5: مجلد مخصص للصور

## البنية الملفات

```
flaky-field/
├── src/
│   ├── components/
│   │   ├── OptimizedImage.astro          # مكون الصورة المحسّن
│   │   ├── OptimizedImage.test.ts        # اختبارات المكون
│   │   └── BlogCard.astro                # محدّث لاستخدام OptimizedImage
│   ├── utils/
│   │   ├── image.ts                      # دوال المساعدة
│   │   └── image.test.ts                 # اختبارات الدوال
│   └── pages/
│       └── blog/
│           └── [slug].astro              # محدّث لاستخدام OptimizedImage
└── public/
    └── images/                           # مجلد الصور
        └── .gitkeep
```

## الخطوات التالية

1. إضافة صور تجريبية في `public/images/`
2. تحديث المقالات الموجودة لاستخدام الصور
3. اختبار الأداء مع صور حقيقية
4. إضافة دعم WebP تلقائي (إذا لزم الأمر)
5. إضافة placeholder للصور أثناء التحميل (optional)

## ملاحظات

- جميع الصور تستخدم lazy loading افتراضياً لتحسين الأداء
- الصور الخارجية لا تحصل على srcset (لأننا لا نتحكم بها)
- يتم عرض تحذير في console إذا كانت الصورة بدون alt text
- النظام يدعم جميع صيغ الصور الشائعة
- الاختبارات تغطي جميع الخصائص المطلوبة (Properties 10, 17, 28, 29, 30, 31)
